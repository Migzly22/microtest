<!DOCTYPE html>
<html lang="en">
  <head>
    <title>testingv2</title>

    <link rel="stylesheet" type="text/css" href="./public/css/font-awesome.css" />
    <link rel="stylesheet" type="text/css" href="./public/css/style.css" />

    <script src="./public/imagedata.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.105.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/panolens@0.12.1/build/panolens.min.js"></script>

    <script>
      if (window.module) module = window.module;
    </script>

    <link rel="stylesheet" href="./public/css/mainstyle.css" />
  </head>
  <body id="body">
    <div id="container" style="color: black"></div>

    <div id="tmp">
      <div id="tmpcontent"></div>
      <div class="mediaclosebutton" onclick="hideTemp()">
        <i class="fa fa-times-circle"></i>
      </div>
    </div>

    <div
      id="loading"
      class="fullwrapper"
      style="display: table; width: 100%; height: 100%"
    >
      <div class="loadingScreen">
        Loading...
        <div id="loadingperc" style="font-size: 12px"></div>
      </div>
    </div>

    <script>
      window.process = { browser: true, env: { ENVIRONMENT: "BROWSER" } };

      var container = document.querySelector("#container");
      /*panolens*/

      var viewer = new PANOLENS.Viewer({
        container: container,
        controlBar: true,
        output: "console",
        autoHideInfospot: false,
      });

      /*panolens-end*/

      viewer.addUpdateCallback(function () {});

      /*panoramas*/

      var testpanorama = new PANOLENS.ImagePanorama(
        "https://i.ibb.co/0ZXc4PZ/testpanorama.jpg"
      );
      testpanorama.addEventListener("progress", onProgress);
      testpanorama.addEventListener("load", function (e) {
        endLoading();
      });
      testpanorama.addEventListener("enter", function (e) {
        endLoading();
      });
      testpanorama.addEventListener("click", function (e) {});

      var infospottestpanorama0 = new PANOLENS.Infospot(
        512,
        hotspotIcons[0].data,
        true
      );
      infospottestpanorama0.position.set(2867.5, -318.56, -4076.57);
      testpanorama.add(infospottestpanorama0);

      infospottestpanorama0.addEventListener("click", function () {
        ChangePanorama("panorama1");
      });

      var infospottestpanorama1 = new PANOLENS.Infospot(
        512,
        hotspotIcons[0].data,
        true
      );
      infospottestpanorama1.position.set(4954.17, 506.86, -321.72);
      testpanorama.add(infospottestpanorama1);

      infospottestpanorama1.addEventListener("click", function () {
        showMedia(1, "https://i.ibb.co/0ZXc4PZ/testpanorama.jpg");
      });

      viewer.add(testpanorama);

      var panorama1 = new PANOLENS.ImagePanorama("https://i.ibb.co/nz6hDTq/panorama1.jpg");
      panorama1.addEventListener("progress", onProgress);
      panorama1.addEventListener("load", function (e) {
        endLoading();
      });
      panorama1.addEventListener("enter", function (e) {
        endLoading();
      });
      panorama1.addEventListener("click", function (e) {});

      viewer.add(panorama1);

      $(document).ready(function () {
        ChangePanorama("testpanorama");
      });

      /*panoramas-end*/

      var stilloading = true;

      function onProgress(event) {
        progress = (event.progress.loaded / event.progress.total) * 100;
        console.log("Loading panorama: " + progress + " ... ");
        $("#loadingperc").html(Math.ceil(progress) + "%");
        if (Math.ceil(progress) >= 100) {
          endLoading();
          stilloading = false;
        } else {
          clearTimeout(elTimer);
          stilloading = true;
          $("#loading").show();
        }
      }

      var elTimer;
      function endLoading() {
        clearTimeout(elTimer);
        if (stilloading == false) {
          elTimer = setTimeout(function () {
            $("#loading").fadeOut();
          }, 750);
        }
      }

      function hideTemp() {
        $("#tmp").fadeOut();
        setTimeout(function () {
          $("#tmpcontent").html("");
        }, 1000);
      }

      function showMedia(type, content) {
        switch (type) {
          case 1:
            //Image
            $("#tmpcontent").html(
              "<img src='" + content + "' style='width: 100%;'>"
            );
            $("#tmp").fadeIn();
            break;
          case 2:
            //Video
            $("#tmpcontent").html(
              "<video id='webvideo' controls autoplay style='width: 100%; height: 100%;'><source src='" +
                content +
                "' type='video/mp4'> Your browser does not support the video tag. </video>"
            );
            $("#tmp").fadeIn();
            break;
          case 3:
            //Audio
            $("#tmpcontent").html(
              "<audio controls style='width: 100%;'><source src='" +
                content +
                "' type='audio/ogg'>Your browser does not support the audio tag.</audio>"
            );
            $("#tmp").fadeIn();
            break;
          case 4:
            //PDF
            $("#tmpcontent").html(
              "<iframe src='pdfjs/web/viewer.html?file=../../" +
                content +
                "' style='width: 100%; height: 99%;'></iframe>"
            );
            $("#tmp").fadeIn();
            break;
        }
      }

      //Update Callback
      viewer.addUpdateCallback(function () {
        /*viewerupdatecallback*/
        if (viewer.panorama == testpanorama) {
        }

        if (viewer.panorama == panorama1) {
        }
        /*viewerupdatecallback-end*/
      });

      var hotspotsvisible = true;
      function ShowMyInfospot(hs, elid) {
        var thehs = toScreenPosition(hs);
        if (thehs.z < 1) {
          $("#" + elid).css({
            top: thehs.y - $("#" + elid).height() / 2 + "px",
            left: thehs.x - $("#" + elid).width() / 2 + "px",
          });
          if (hotspotsvisible) $("#" + elid).show();
        } else {
          $("#" + elid).hide();
        }
      }

      function toScreenPosition(obj) {
        var vector = new THREE.Vector3();
        var widthHalf = 0.5 * innerWidth;
        var heightHalf = 0.5 * innerHeight;

        //obj.updateMatrixWorld();
        vector.setFromMatrixPosition(obj.matrixWorld);

        vector.project(viewer.camera);

        vector.x = vector.x * widthHalf + widthHalf;
        vector.y = -(vector.y * heightHalf) + heightHalf;

        return {
          x: vector.x,
          y: vector.y,
          z: vector.z,
        };
      }

      var currentPanorama;
      function ChangePanorama(panorama) {
        currentPanorama = panorama;
        HideInfospots();
        $("#loading").fadeIn();
        $(".customhotspot").fadeOut();
        setTimeout(function () {
          viewer.setPanorama(window[panorama]);
        }, 100);
        setTimeout(function () {
          $("#" + panorama).fadeIn();
        }, 1000);
      }

      function HideInfospots() {
        $(".customhotspot").fadeOut();
      }
    </script>
  </body>
</html>
